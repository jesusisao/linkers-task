# linkers-task 技術説明資料

## 開発環境

python 3.8.0で動作確認を行っています。

また、実行ファイルを生成するためにpyinstallerを使用しています。
2019/11/03現在、python 3.8.0に対応したpyinstallerは未リリースのため、
開発用のものを直接pipでインストールする必要がありました。
それ以外は標準のライブラリを使用しています。

```
pip install https://github.com/pyinstaller/pyinstaller/archive/develop.tar.gz

# ※ PyInstaller 4.0.dev0+5d4bbbeea を使ってビルドを行いました。
```

## 実行

linkerstask.pyがエントリとなるため、ここをpython3として実行するのと、
バイナリとして実行することは等価です。

### 例：インデックスの作成 

#### 直接実行

```
python3 linkerstask.py index
```

#### バイナリで実行

```
./linkerstask index
```

## 単体テスト実行

```
python3 -m unittest
```

## バイナリファイルのビルド

```
pyinstaller linkerstask.py --onefile --clean
```

## 内部の処理について

プロダクションコードの部分はネストが４段以内に収まるようにしました。

### 複数行住所の対応について

複数行の住所の対応をするためにやったことは、
あるCSVの行を見たときに、その行が住所の終わりであるかどうかを判定することです。

判定の方法は、

1.郵便番号が複数の町域を表すときは住所の終わり。
2.郵便番号が複数の町域を表さず、次の行と郵便番号が異なるときは、住所の終わり。

であると判定しています。

なお、この判定はインデックスを作成する時点で行っています。

### インデックスファイルについて

インデックスファイルは二文字をキーとしてCSV行のリストを値とした辞書の形式になっています。
インデックスを作成する段階で、住所の終わり判定を行って行数を算出しています。
つまり、インデックスの行数には複数行の住所の先頭の行数が入るようになっています。

インデックスファイルは、pythonの辞書にそのまま展開して使う予定のため、
キーのハッシュ化等は不要だと判断し特に行っていません。

### N-Gramについて

この分野に明るくないので詳しくは分かりかねるのですが、
「東京都」で検索したときに「東京」と「京都」で出てくるのではなく、
「京都」で検索したときに「東京都」と「京都」が出てくるのが正しい挙動なのではないか……？と思いました。
間違えていたらごめんなさい。

デフォルトの挙動としては課題指示書にあった例2の通り、「東京都」→「東京」「京都」が出るようになっています。
オプションとして-pをつけると、「東京都」→「東京都〜」が出るようになっています。

検索文字列をN=2で分解して、該当するものがインデックスの辞書にあるかを検索します。

例：東京都

```
{
    東京: [1, 2, 3],
    京都: [1, 6]
}
```

キーはCSVの住所名をN=2で分解したもので、値は行数のリストです。
デフォルトの挙動では、この和集合、1,2,3,6行目の検索結果を取得します。
そのため、東京と京都が出てきます。

-pオプションをつけた場合は、和集合ではなく積集合になっているため、
1行目の検索結果のみを取得します。
そのため、東京都に一致するもののみが出てきます。
